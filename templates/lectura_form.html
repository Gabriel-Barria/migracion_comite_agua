{% extends 'base.html' %}
{% block title %}{{ 'Editar' if lectura else 'Nueva' }} Lectura - Comité de Agua{% endblock %}
{% block content %}
<div class="header-actions">
    <h1>{{ 'Editar' if lectura else 'Nueva' }} Lectura</h1>
    <a href="{{ url_for('lecturas') }}" class="btn btn-secondary">Volver</a>
</div>

<form method="POST" enctype="multipart/form-data" class="form-card">
    <h3>Datos de Lectura</h3>
    <div class="form-row">
        <div class="form-group">
            <label>Periodo * (MM-YYYY)</label>
            <input type="text" name="periodo" id="periodo" value="{{ lectura.periodo if lectura else '' }}" placeholder="01-2025" required onchange="cargarUsuarios()">
            {% if not lectura %}<small>Ingresa el periodo primero para ver usuarios disponibles</small>{% endif %}
        </div>
        <div class="form-group">
            <label>Usuario * <span id="usuarios_count"></span></label>
            <select name="usuario_id" id="usuario_id" required>
                <option value="">{% if lectura %}Seleccionar...{% else %}Primero ingresa el periodo{% endif %}</option>
                {% if lectura %}
                {% for u in usuarios %}
                <option value="{{ u.id }}" {% if lectura.usuario_id == u.id %}selected{% endif %}>{{ u.primer_apellido }}, {{ u.nombre }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="form-group">
            <label>Fecha Lectura</label>
            <input type="date" name="fecha_lectura" value="{{ lectura.fecha_lectura if lectura else '' }}">
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Lectura Anterior *</label>
            <div style="display: flex; gap: 5px;">
                <input type="number" name="lectura_anterior" id="lectura_anterior" value="{{ lectura.lectura_anterior|int if lectura else '' }}" step="1" required onchange="calcular()" {% if not lectura %}readonly{% endif %} style="flex: 1;">
                <button type="button" id="btn_editar_anterior" onclick="habilitarEdicionAnterior()" class="btn btn-secondary" style="padding: 5px 10px;" title="Editar manualmente">&#9998;</button>
            </div>
            {% if not lectura %}<small id="lectura_anterior_info">Se carga automáticamente al seleccionar usuario</small>{% endif %}
        </div>
        <div class="form-group">
            <label>Lectura Actual *</label>
            <input type="number" name="lectura_actual" id="lectura_actual" value="{{ lectura.lectura_actual|int if lectura else '' }}" step="1" required onchange="calcular()">
        </div>
        <div class="form-group">
            <label>Foto del Medidor</label>
            <input type="file" name="imagen_medidor" id="imagen_medidor" accept="image/*" onchange="previsualizarImagen(this, 'preview_medidor')">
            <div id="preview_medidor" class="preview-container">
                {% if lectura and lectura.imagen_medidor %}
                <img src="{{ url_for('ver_medidor', filename=lectura.imagen_medidor) }}" alt="Foto medidor">
                {% endif %}
            </div>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Tarifa por m³</label>
            <input type="number" name="tarifa_m3" id="tarifa_m3" value="{{ lectura.tarifa_m3 if lectura else 1182.6 }}" step="0.1" onchange="calcular()">
        </div>
        <div class="form-group">
            <label>Cargo Fijo</label>
            <input type="number" name="cargo_fijo" id="cargo_fijo" value="{{ lectura.cargo_fijo if lectura else 5000 }}" step="1" onchange="calcular()">
        </div>
    </div>
    <div class="form-row calc-row">
        <div class="calc-item"><span>Consumo:</span> <strong id="consumo_display">0</strong> m³</div>
        <div class="calc-item"><span>Subtotal:</span> $<strong id="subtotal_display">0</strong></div>
        <div class="calc-item"><span>Total Factura:</span> $<strong id="total_display">0</strong></div>
    </div>

    <hr>
    <h3>Datos de Pago</h3>
    <div class="form-row">
        <div class="form-group">
            <label>Estado de Pago</label>
            <select name="estado_pago" id="estado_pago">
                <option value="PENDIENTE" {% if not lectura or lectura.estado_pago == 'PENDIENTE' %}selected{% endif %}>PENDIENTE</option>
                <option value="PAGADO" {% if lectura and lectura.estado_pago == 'PAGADO' %}selected{% endif %}>PAGADO</option>
            </select>
        </div>
        <div class="form-group">
            <label>Monto Pagado</label>
            <input type="number" name="monto_pagado" id="monto_pagado" value="{{ lectura.monto_pagado if lectura else 0 }}" step="1" onchange="calcular()">
        </div>
        <div class="form-group">
            <label>Saldo Pendiente</label>
            <input type="text" id="saldo_display" readonly>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Fecha de Pago</label>
            <input type="date" name="fecha_pago" value="{{ lectura.fecha_pago if lectura else '' }}">
        </div>
        <div class="form-group">
            <label>Forma de Pago</label>
            <select name="forma_pago">
                <option value="">Seleccionar...</option>
                <option value="Efectivo" {% if lectura and lectura.forma_pago == 'Efectivo' %}selected{% endif %}>Efectivo</option>
                <option value="Transferencia" {% if lectura and lectura.forma_pago == 'Transferencia' %}selected{% endif %}>Transferencia</option>
            </select>
        </div>
        <div class="form-group">
            <label>Comprobante de Pago</label>
            <input type="file" name="comprobante_pago" id="comprobante_pago" accept="image/*,.pdf" onchange="previsualizarImagen(this, 'preview_comprobante')">
            <div id="preview_comprobante" class="preview-container">
                {% if lectura and lectura.comprobante_pago %}
                {% if lectura.comprobante_pago.endswith('.pdf') %}
                <a href="{{ url_for('ver_comprobante', filename=lectura.comprobante_pago) }}" target="_blank" class="btn btn-secondary">Ver PDF</a>
                {% else %}
                <img src="{{ url_for('ver_comprobante', filename=lectura.comprobante_pago) }}" alt="Comprobante">
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Guardar</button>
        <a href="{{ url_for('lecturas') }}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<!-- Modal para ver imagen grande -->
<div id="modal-imagen" class="modal-imagen" onclick="cerrarModal()">
    <span class="modal-cerrar">&times;</span>
    <img id="modal-img" src="" alt="Imagen ampliada">
</div>

<script>
const esEdicion = {{ 'true' if lectura else 'false' }};

function cargarUsuarios() {
    const periodo = document.getElementById('periodo').value;
    const select = document.getElementById('usuario_id');
    const countSpan = document.getElementById('usuarios_count');

    if (!periodo || esEdicion) return;

    select.innerHTML = '<option value="">Cargando...</option>';

    fetch('/api/usuarios-disponibles?periodo=' + encodeURIComponent(periodo))
        .then(response => response.json())
        .then(usuarios => {
            select.innerHTML = '<option value="">Seleccionar...</option>';
            usuarios.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = u.primer_apellido + ', ' + u.nombre;
                select.appendChild(option);
            });
            countSpan.textContent = '(' + usuarios.length + ' disponibles)';
        })
        .catch(err => {
            select.innerHTML = '<option value="">Error al cargar</option>';
            console.error(err);
        });

    // Limpiar lectura anterior cuando cambia el periodo
    if (!esEdicion) {
        document.getElementById('lectura_anterior').value = '';
        calcular();
    }
}

function cargarLecturaAnterior() {
    const periodo = document.getElementById('periodo').value;
    const usuarioId = document.getElementById('usuario_id').value;
    const inputAnterior = document.getElementById('lectura_anterior');
    const infoSpan = document.getElementById('lectura_anterior_info');

    if (!periodo || !usuarioId || esEdicion) return;

    fetch('/api/lectura-anterior?usuario_id=' + encodeURIComponent(usuarioId) + '&periodo=' + encodeURIComponent(periodo))
        .then(response => response.json())
        .then(data => {
            inputAnterior.value = data.lectura_anterior;
            if (infoSpan) {
                if (data.lectura_anterior > 0) {
                    infoSpan.textContent = 'Cargado del periodo anterior';
                } else {
                    infoSpan.textContent = 'Sin registros anteriores (valor: 0)';
                }
            }
            calcular();
        })
        .catch(err => {
            console.error(err);
            inputAnterior.value = 0;
            calcular();
        });
}

function habilitarEdicionAnterior() {
    const input = document.getElementById('lectura_anterior');
    const btn = document.getElementById('btn_editar_anterior');
    const infoSpan = document.getElementById('lectura_anterior_info');

    if (input.readOnly) {
        input.readOnly = false;
        input.focus();
        btn.innerHTML = '&#10003;';
        btn.title = 'Confirmar edición';
        if (infoSpan) infoSpan.textContent = 'Modo edición manual';
    } else {
        input.readOnly = true;
        btn.innerHTML = '&#9998;';
        btn.title = 'Editar manualmente';
        if (infoSpan) infoSpan.textContent = 'Valor editado manualmente';
    }
}

function calcular() {
    const anterior = parseFloat(document.getElementById('lectura_anterior').value) || 0;
    const actual = parseFloat(document.getElementById('lectura_actual').value) || 0;
    const tarifa = parseFloat(document.getElementById('tarifa_m3').value) || 0;
    const cargoFijo = parseFloat(document.getElementById('cargo_fijo').value) || 0;
    const pagado = parseFloat(document.getElementById('monto_pagado').value) || 0;

    const consumo = actual - anterior;
    const subtotal = consumo * tarifa;
    const total = subtotal + cargoFijo;
    const saldo = total - pagado;

    document.getElementById('consumo_display').textContent = consumo.toFixed(0);
    document.getElementById('subtotal_display').textContent = subtotal.toLocaleString('es-CL', {maximumFractionDigits: 0});
    document.getElementById('total_display').textContent = total.toLocaleString('es-CL', {maximumFractionDigits: 0});
    document.getElementById('saldo_display').value = '$' + saldo.toLocaleString('es-CL', {maximumFractionDigits: 0});
}

// Agregar listener al cambio de usuario
document.getElementById('usuario_id').addEventListener('change', cargarLecturaAnterior);

function previsualizarImagen(input, previewId) {
    const preview = document.getElementById(previewId);
    preview.innerHTML = '';

    if (input.files && input.files[0]) {
        const file = input.files[0];

        if (file.type === 'application/pdf') {
            preview.innerHTML = '<span class="pdf-preview">PDF seleccionado: ' + file.name + '</span>';
        } else if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Preview';
                img.onclick = function() { abrirModal(this.src); };
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }
}

function abrirModal(src) {
    const modal = document.getElementById('modal-imagen');
    const modalImg = document.getElementById('modal-img');
    modal.style.display = 'flex';
    modalImg.src = src;
}

function cerrarModal() {
    document.getElementById('modal-imagen').style.display = 'none';
}

// Agregar click a imágenes existentes
document.querySelectorAll('.preview-container img').forEach(img => {
    img.onclick = function() { abrirModal(this.src); };
});

calcular();
// Si ya hay periodo al cargar, cargar usuarios
if (document.getElementById('periodo').value && !esEdicion) {
    cargarUsuarios();
}
</script>
{% endblock %}
